<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>InstaSquare</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/index.css">
  <script src="js/jimp.min.js"></script>
  <script src="js/jszip.min.js"></script>
  <script src="js/FileSaver.min.js"></script>
</head>

<body>
  <input type="file" id="file" name="files[]" onchange="newFiles(this)" multiple />
  <button onclick="downloadZip()">Download Squared Images</button>
  <br>
  <br>
  <div id="app"></div>
  <script>
    var app = document.getElementById("app");


    function downloadZip() {
      var zip = new JSZip();

      var links = document.querySelectorAll(".img_link");
      for (var i = 0; i < links.length; ++i) {
        // Add a file to the directory, in this case an image with data URI as contents
        zip.file(links[i].download, links[i].href.split('base64,')[1], {
          base64: true
        });
      }


      // Generate the zip file asynchronously
      zip.generateAsync({
          type: "blob"
        })
        .then(function (content) {
          // Force down of the Zip file
          saveAs(content, "images.zip");
        });
    }

    function newFiles(element) {
      for (var i = 0; i < element.files.length; ++i) {
        readFileAndProcess(element.files[i]);
      }
      showBtn();
      
      function readFileAndProcess(readfile) {
        var reader = new FileReader();
        reader.addEventListener("load", function () {
          var worker = new Worker("js/worker.js");
          worker.onmessage = function (e) {
            var squared_file = readfile.name.split(".")[0] + "_squared." + readfile.name.split(".")[1];

            var img_wrapper = document.createElement("div");
            img_wrapper.classList.add("img_wrapper");

            var img_data = document.createElement("img");
            img_data.classList.add("img_data");
            img_data.setAttribute("src", e.data);

            var img_link = document.createElement("a");
            img_link.classList.add("img_link");
            img_link.setAttribute("href", e.data);
            img_link.setAttribute("download", squared_file)

            var removeBtn = document.createElement("span");
            removeBtn.classList.add("remove");
            removeBtn.innerHTML = "&times;";
            removeBtn.addEventListener("click", function () {
              // console.log("this",this);
              // console.log("grandparent",this.parentNode.parentNode);
              // console.log("parent",this.parentNode);
              this.parentNode.parentNode.removeChild(this.parentNode);
            });

            img_link.appendChild(img_data);
            img_wrapper.appendChild(img_link);
            img_wrapper.appendChild(removeBtn);
            app.appendChild(img_wrapper);


          };
          worker.postMessage(this.result);
        });
        reader.readAsArrayBuffer(readfile);
      }

      function showBtn() {
        document.querySelector("button").style.display = "inline";
      }
    }
  </script>
</body>

</html>